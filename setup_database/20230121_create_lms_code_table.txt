set charset utf8mb4;

BEGIN;

# LMSコードテーブル作成
CREATE TABLE lms_code (
    id INT UNSIGNED AUTO_INCREMENT,
    lms_code VARCHAR(16) NOT NULL UNIQUE,
    create_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY(id)
) ENGINE=InnoDB;

CREATE INDEX index_lms_code_lms_code ON lms_code(lms_code);


# LMSコードテーブルに現在のschoolテーブルにあるlms_codeからレコードを作成する
INSERT INTO lms_code (lms_code) SELECT lms_code FROM school;


# schoolにlms_code_idカラムを追加
ALTER TABLE school ADD COLUMN lms_code_id BIGINT NOT NULL;


# lms_code_idにidを当て込む
UPDATE school SET lms_code_id = (SELECT id FROM lms_code WHERE lms_code.lms_code = school.lms_code);


# schoolからlms_codeカラムを削除
ALTER TABLE school DROP COLUMN lms_code;


# ビューを更新
DROP VIEW teacher_school_view;

CREATE VIEW teacher_school_view AS SELECT t.*, s.name AS school_name, s.zip AS school_zip, s.pref AS school_pref, s.address AS school_address, s.phone AS school_phone, lc.lms_code FROM teacher AS t INNER JOIN school AS s ON t.school_id = s.id INNER JOIN lms_code AS lc ON s.lms_code_id = lc.id;


# 学校用にビューを追加作成
CREATE VIEW school_view AS SELECT s.*, lc.lms_code FROM school AS s INNER JOIN lms_code AS lc ON s.lms_code_id = lc.id;

COMMIT;
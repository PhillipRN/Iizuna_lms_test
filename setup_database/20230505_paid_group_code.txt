set charset utf8mb4;

BEGIN;

ALTER TABLE school_group ADD COLUMN paid_application_status SMALLINT NOT NULL DEFAULT 0 AFTER name;


CREATE TABLE lms_code_amount (
    id BIGINT UNSIGNED AUTO_INCREMENT,
    lms_code_id BIGINT UNSIGNED NOT NULL UNIQUE,
    use_count BIGINT UNSIGNED NOT NULL DEFAULT 0,
    available_total INT NOT NULL DEFAULT 0,
    application_total INT NOT NULL DEFAULT 0,
    create_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY(id)
) ENGINE=InnoDB;

CREATE INDEX index_lms_code_amount_lms_code_id ON lms_code_amount(lms_code_id);


DROP VIEW school_group_view;

CREATE VIEW school_group_view AS SELECT sg.*, lc.lms_code, t.name_1 AS teacher_name_1, t.name_2 AS teacher_name_2, lca.use_count, lca.available_total, lca.application_total FROM school_group AS sg INNER JOIN lms_code AS lc ON sg.lms_code_id = lc.id INNER JOIN teacher AS t ON sg.teacher_id = t.id LEFT JOIN lms_code_amount AS lca ON sg.lms_code_id = lca.lms_code_id;


CREATE TABLE lms_code_application (
    id BIGINT UNSIGNED AUTO_INCREMENT,
    lms_code_id BIGINT UNSIGNED NOT NULL,
    paid_application_status SMALLINT NOT NULL DEFAULT 0,
    available_amount INT NOT NULL DEFAULT 0,
    application_amount INT NOT NULL DEFAULT 0,
    create_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_date DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY(id)
) ENGINE=InnoDB;

CREATE INDEX index_lms_code_application_lms_code_id ON lms_code_application(lms_code_id);


INSERT INTO lms_code_amount (lms_code_id) SELECT id FROM lms_code lc WHERE lc.id NOT IN (SELECT lms_code_id FROM lms_code_amount) ORDER BY id ASC;

COMMIT;
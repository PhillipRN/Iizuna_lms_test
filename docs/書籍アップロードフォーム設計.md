# 書籍アップロードフォーム設計・開発手順

開発環境（`docs/開発ワークフローガイド.md` 参照）で編集部向けの書籍アップロード機能を実装し、AWS複製環境で検証後に本番へ反映するための設計書です。`ReadMe.md` は本番用運用ドキュメントなので参照対象から外してください。

## 1. 背景と目的
- 現状は `docs/LMS・おまかせ用書籍追加 更新手順マニュアル.md` に従い、エンジニアが手動でExcel→CSV変換→DB反映を行っている。
- 編集部が直接アップロードできるフォームを提供し、Excel不備を即時に表示することで再作業と依存を減らす。

## 2. 現状フローの要点
1. Excelを整形し `setup_database/iizuna_lms/import/<任意フォルダ>` に配置
2. `php converter.php` で `export/` 以下にCSV生成
3. CSVを `setup_database/batch` に転送し `auto_setup_with_directory_name.sh` でMySQL登録
4. `php app/Commands/setup_book_range.php` で範囲情報作成
5. 本番にダンプして流し込み

## 3. 新機能のゴール
- 管理画面（例：`/il_admin/books/upload`）でExcel（.xls/.xlsx）と任意の識別フォルダ名を投稿
- アップロード直後にサーバー側で構文・値チェックを実施し、エラーがあればアップロード処理を即座に打ち切って画面に表示（不備のあるExcelは保存しない）
- 問題なければ `setup_database/iizuna_lms/import/<日付>/` に保存し、既存の `converter.php` をPHPから呼び出してCSVを作成
- 生成されたCSVは `setup_database/iizuna_lms/export/<処理ID>` に保存し、バリデーションOKなら自動で `setup_database/batch/auto_setup_with_directory_name.sh` と `app/Commands/setup_book_range.php` を連続実行してDBへ反映（プレビューだけ可能な「ドライラン」モードも用意）

## 4. 要件
### 機能要件
- 構文／ビジネスバリデーションに通ったExcelのみ「アップロード成功」と判定し、不備がある場合はサーバー側でアップロード自体を失敗させ一時保存ファイルも削除
- 単一/複数ファイルアップロード（最大5個まで）
- Excel内容のチェック：必須シート存在、列名検証、配分比率の端数や空行混入の検知
- バリデーション結果の即時表示（表形式で行番号・項目・エラー理由）
- 正常時は処理ID（例：`BOOK-20251105-001`）を払い出し、`export/<処理ID>/TCxxxx` へのパスを記録

### 非機能要件
- PHP 8.2 + Smartyで実装、既存 `Admin` 中の認可ロジックを流用
- ファイル上限50MB、進捗用スピナー表示
- 監査ログを `app/Logs/book_upload.log` に出力（ユーザーID・処理ID・結果）

## 5. アーキテクチャ案
- Controller: `app/Controllers/AdminBookUploadController.php`
- Service: `app/Services/BookUploadService.php`（PhpSpreadsheetで解析・バリデーション）
- Job/Command: 既存 `setup_database/iizuna_lms/converter.php` を `symfony/process` もしくは `proc_open` で呼び出し、例外処理を丁寧に行う
- View: `app/Views/admin/books/upload.tpl`（Smarty）
- ルーティング: `app/Routes/admin.php` に `/books/upload` を追加、ADMINロールのみアクセス

## 6. 処理フロー
1. 画面からPOST → CSRF検証
2. 一時保存 (`storage/uploads/books/tmp/<uuid>`)
3. PhpSpreadsheetで各シート読込 → ルールチェック（シート欠落、列順、配分比率合計100%、末尾空行など）
4. エラーがあればJSONレスポンスで返し、テンプレートで一覧表示
5. 問題なければ `setup_database/iizuna_lms/import/<処理ID>` に永続保存
6. `converter.php` を呼び出し `export/<処理ID>` 作成後、そのまま `setup_database/batch/auto_setup_with_directory_name.sh <処理ID>` と `php app/Commands/setup_book_range.php --id=<処理ID>` をサブプロセスで連続実行（ドライラン指定時はSQLを`/tmp/book_upload/<処理ID>.sql` に出力してDB更新をスキップ）
7. 実行ログ（標準出力・エラー）と更新対象テーブル、作成されたCSVパスを画面に表示し、失敗時は自動ロールバックなしでDB未反映の状態を保持。

## 7. バリデーション仕様
- シート名: `01_メタ情報`, `02_問題形式` など、手順マニュアル記載の必須シートが揃っていること
- 列チェック: 例 `問題ID`, `配点`, `正解` は必須。型（数値/文字列）と正規表現を設定
- ビジネスルール: 配分比率が合計100になる、行重複がない、空欄が無い、全角/半角の統一
- エラー表示例: `行125 / 列「配点」: 数字ではありません`

## 8. UIポイント
- フォーム: ファイル選択 + フォルダ名 + 備考
- バリデーション結果: テーブル + CSVダウンロード可能なエラーレポート
- ガイド: 右側に「Excel整形チェックリスト」（フィルタ解除・集計行削除など）を常に表示

## 9. 開発ステップ
1. **ブランチ作成**: `git checkout -b feature/book-upload-form`
2. **ローカル実装**
   - コントローラ・サービス・ビュー追加
   - `composer require symfony/process` が必要なら追加（要 `make composer-install`）
   - `make up` でDocker起動、`http://localhost:8080/il_admin/books/upload` で動作確認
3. **単体テスト**
   - PhpSpreadsheet依存の検証を `tests/BookUpload/BookUploadServiceTest.php` に追加
   - `make test` でPHPUnit 8実行
4. **イメージ確認**
   - スクリーンショットを `docs/no_use/` など共有不可ディレクトリに保存しPRに添付
5. **AWS複製環境**
   - GitHubへpush → `spapp-dev-clone` で `git pull`
   - `.env`/`config.ini` のアップロード先ディレクトリ権限 (www-data) を確認
   - 実データの試験アップロード → DynamoDB/ RDSへ影響しないよう処理ID単位で分離
6. **レビュー & リリース**
   - PRに `docs/開発ワークフローガイド.md` 手順準拠の検証ログを添付
   - 問題なければ本番へデプロイ、`book_upload.log` を監視

## 10. テスト計画
- 正常系: 単一/複数ファイル、配分合計、自動生成ID、converter呼び出し
- 異常系: シート欠落、列名誤り、型不一致、50MB超過、converter失敗（exit code!=0）
- 負荷: 5ファイル連続アップロード時の処理時間を計測し、タイムアウト設定（Nginx/PHP-FPM）を調整
- AWS複製環境で実データを使い、DB反映スクリプトに渡るCSVが手動手順と同一になることを比較

## 11. ロールアウトと教育
- 編集部向けに操作マニュアル（スクリーンショット付き）を別途 `docs/編集部向け書籍アップロード手順.md` として作成
- 本番反映直後は編集部の最初の2案件を開発側でモニタリングし、`book_upload.log` とS3/ローカルフォルダの整合を確認
- 問題が出た場合は処理IDをキーに `setup_database/iizuna_lms/import/export` を手動で再処理できるようRunbookを整備

# いいずなLMS 開発環境構築ガイド

## 目次
1. [環境選択](#環境選択)
2. [プランA: 既存AWS開発環境の利用](#プランa-既存aws開発環境の利用)
3. [プランB: ローカルDocker環境の構築](#プランb-ローカルdocker環境の構築)
4. [xserver/Cloudflare/Vercelについて](#xservercloudfarevercelについて)

---

## 環境選択

### システム要件
- **PHP**: 8.2以上
- **MySQL**: 5.7以上（utf8mb4対応）
- **拡張機能**: json, pdo, curl
- **外部サービス**: AWS DynamoDB, Firebase, 外部API
- **Cron**: 毎分実行が必要

### 推奨環境
1. **AWS開発環境（spapp-dev-ec2）** - 本番と同じ構成 ⭐最推奨
2. **ローカルDocker環境** - 完全にローカルで開発可能
3. ~~xserver~~ - DynamoDB/Cron制約により非推奨
4. ~~Cloudflare/Vercel~~ - PHP非対応のため不可

---

## プランA: 既存AWS開発環境の利用

### 前提条件
- SSHキーペア: `spapp-dev-keypair.pem`
- アクセス先: `15.152.199.165`

### 1. SSH接続設定

`~/.ssh/config` に以下を追加：

```ini
Host spapp-dev
  Hostname 15.152.199.165
  User ec2-user
  IdentityFile ~/.ssh/spapp-dev-keypair.pem
```

### 2. 接続確認

```bash
# SSH接続テスト
ssh spapp-dev

# アプリケーションディレクトリ確認
cd /var/www/iizuna_lms/
ls -la
```

### 3. 開発環境の更新

```bash
# 最新コードをpull
git fetch
git checkout develop  # または作業ブランチ

# 依存関係更新
composer install

# 設定ファイル確認
cat app/config.ini
```

### 4. データベース接続確認

```bash
# MySQL接続テスト
mysql -h db-dev.spapp-db.localdomain -u iizunaLMS -p iizunaLMS

# テーブル確認
SHOW TABLES;
```

### 5. アプリケーションアクセス

ブラウザで開発環境URLにアクセス（URLは環境により異なる）

### メリット
✅ 本番と同じ構成  
✅ DynamoDB/Firebase等の外部サービスがそのまま利用可能  
✅ Cronも設定済み  
✅ すぐに開発開始可能

### デメリット
❌ SSHキーが必要  
❌ AWSアクセス権限が必要  
❌ ネットワーク接続が必須

---

## プランB: ローカルDocker環境の構築

本番環境と完全に同じ機能を持つローカル開発環境を構築します。

### 1. 必要なツールのインストール

```bash
# Docker Desktop インストール（公式サイトからダウンロード）
# https://www.docker.com/products/docker-desktop

# インストール確認
docker --version
docker-compose --version
```

### 2. Docker環境ファイルの作成

プロジェクトルートに以下のファイルを作成します：

#### `docker-compose.yml`

```yaml
version: '3.8'

services:
  # PHPアプリケーション
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iizuna-lms-app
    ports:
      - "8080:80"
    volumes:
      - .:/var/www/html
      - ./app/config.ini:/var/www/html/app/config.ini
    environment:
      - PHP_VERSION=8.2
    depends_on:
      - mysql-iizuna
      - mysql-onigiri
    networks:
      - iizuna-network

  # iizunaLMS用MySQL
  mysql-iizuna:
    image: mysql:8.0
    container_name: iizuna-lms-db
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: iizunaLMS
      MYSQL_USER: iizunaLMS
      MYSQL_PASSWORD: Gawbvgt2f983mru
    volumes:
      - mysql-iizuna-data:/var/lib/mysql
      - ./database.txt:/docker-entrypoint-initdb.d/01-init.sql
      - ./setup_database:/docker-entrypoint-initdb.d/migrations
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - iizuna-network

  # ONIGIRI用MySQL
  mysql-onigiri:
    image: mysql:8.0
    container_name: iizuna-onigiri-db
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: onigiri
      MYSQL_USER: onigiri
      MYSQL_PASSWORD: onigiri_pass
    volumes:
      - mysql-onigiri-data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - iizuna-network

  # DynamoDB Local（開発用）
  dynamodb-local:
    image: amazon/dynamodb-local
    container_name: iizuna-dynamodb
    ports:
      - "8000:8000"
    command: -jar DynamoDBLocal.jar -sharedDb
    volumes:
      - dynamodb-data:/home/dynamodblocal/data
    networks:
      - iizuna-network

  # phpMyAdmin（DB管理ツール）
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: iizuna-phpmyadmin
    ports:
      - "8081:80"
    environment:
      PMA_HOSTS: mysql-iizuna,mysql-onigiri
      PMA_USER: root
      PMA_PASSWORD: rootpassword
    depends_on:
      - mysql-iizuna
      - mysql-onigiri
    networks:
      - iizuna-network

volumes:
  mysql-iizuna-data:
  mysql-onigiri-data:
  dynamodb-data:

networks:
  iizuna-network:
    driver: bridge
```

#### `Dockerfile`

```dockerfile
FROM php:8.2-apache

# 必要なパッケージのインストール
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    libzip-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libicu-dev \
    libonig-dev \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    pdo \
    pdo_mysql \
    mysqli \
    zip \
    gd \
    intl \
    mbstring \
    opcache

# Composer インストール
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Apache設定
RUN a2enmod rewrite
COPY docker/apache-config.conf /etc/apache2/sites-available/000-default.conf

# 作業ディレクトリ設定
WORKDIR /var/www/html

# 依存関係のインストール
COPY composer.json composer.lock ./
RUN composer install --no-scripts --no-autoloader

# アプリケーションファイルのコピー
COPY . .

# Composer autoload最適化
RUN composer dump-autoload --optimize

# 権限設定
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

EXPOSE 80
```

#### `docker/apache-config.conf`

```apache
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

### 3. 開発用設定ファイルの作成

#### `app/config.ini`（Docker用）

```ini
DEBUG_MODE = 1
DISPLAY_ERROR_ALL = 1
ADMIN_LOGIN_ID = admin
ADMIN_LOGIN_PW = admin123

# MySQL設定（Docker内のサービス名を使用）
DB_HOST = mysql-iizuna
DB_NAME = iizunaLMS
DB_USER = iizunaLMS
DB_PASS = Gawbvgt2f983mru

ONIGIRI_DB_HOST = mysql-onigiri
ONIGIRI_DB_NAME = onigiri
ONIGIRI_DB_USER = onigiri
ONIGIRI_DB_PASS = onigiri_pass

WWW_ROOT_URL = http://localhost:8080

# DynamoDB Local使用
USE_DYNAMO_DB = 1
DYNAMO_DB_ACCESS_TOKEN_TABLE = dev-access-token
DYNAMO_DB_LOGIN_TOKEN_TABLE = dev-login-token
DYNAMO_DB_AUTO_LOGIN_TOKEN_TABLE = dev-auto-login-token
# AWS_ENDPOINT = http://dynamodb-local:8000  # ← アプリ側でendpoint設定が必要

# 外部API（開発環境のURL）
ONIGIRI_API = https://onigiri-dev-api.example.net/
ONIGIRI_BASIC_AUTH_FLAG = 0
ONIGIRI_USER_API = https://onigiri-dev-api.example.net/adminApi/
ONIGIRI_NOTIFICATION_FLAG = 0
ONIGIRI_NOTIFICATION_API = https://onigiri-dev-api.example.net/adminApi/

# メール設定（開発用）
MAIL_SMTP_HOST = mailhog
MAIL_SMTP_USER_NAME = 
MAIL_SMTP_PASSWORD = 
MAIL_SMTP_PORT = 1025
MAIL_SMTP_SECURE = 
MAIL_FROM_ADDRESS = dev@iizuna-lms.local
MAIL_FROM_NAME = いいずなLMS開発
MAIL_REPLY_ADDRESS = dev@iizuna-lms.local
MAIL_REPLY_NAME = 開発環境
MAIL_RETURN_PATH = dev@iizuna-lms.local
MAIL_BCC = 

# Firebase（開発用プロジェクトID）
FIREBASE_PROJECT_ID = iizuna-lms-dev

# 電子書籍API
DENSHI_SHOSEKI_API = https://dev-api.example.com
DENSHI_SHOSEKI_API_KEY = dev-api-key
```

### 4. DynamoDB Local用テーブル作成スクリプト

#### `scripts/setup-dynamodb-local.sh`

```bash
#!/bin/bash

# DynamoDB Localにテーブルを作成

AWS_ENDPOINT="http://localhost:8000"
AWS_REGION="ap-northeast-1"

echo "Creating DynamoDB Local tables..."

# Access Token テーブル
aws dynamodb create-table \
    --table-name dev-access-token \
    --attribute-definitions \
        AttributeName=access_token,AttributeType=S \
    --key-schema \
        AttributeName=access_token,KeyType=HASH \
    --provisioned-throughput \
        ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --endpoint-url $AWS_ENDPOINT \
    --region $AWS_REGION \
    2>/dev/null || echo "dev-access-token table already exists"

# Login Token テーブル
aws dynamodb create-table \
    --table-name dev-login-token \
    --attribute-definitions \
        AttributeName=login_token,AttributeType=S \
    --key-schema \
        AttributeName=login_token,KeyType=HASH \
    --provisioned-throughput \
        ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --endpoint-url $AWS_ENDPOINT \
    --region $AWS_REGION \
    2>/dev/null || echo "dev-login-token table already exists"

# Auto Login Token テーブル
aws dynamodb create-table \
    --table-name dev-auto-login-token \
    --attribute-definitions \
        AttributeName=auto_login_token,AttributeType=S \
    --key-schema \
        AttributeName=auto_login_token,KeyType=HASH \
    --provisioned-throughput \
        ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --endpoint-url $AWS_ENDPOINT \
    --region $AWS_REGION \
    2>/dev/null || echo "dev-auto-login-token table already exists"

echo "DynamoDB Local setup complete!"
```

### 5. 環境起動手順

```bash
# 1. プロジェクトルートに移動
cd /Users/phillipr.n./Documents/KUTO/いいずな/iizuna_apps_dev/iizuna-lms-main

# 2. Docker環境起動
docker-compose up -d

# 3. ログ確認
docker-compose logs -f app

# 4. コンテナ内に入る
docker exec -it iizuna-lms-app bash

# 5. 依存関係インストール（コンテナ内）
composer install

# 6. DynamoDBテーブル作成
chmod +x scripts/setup-dynamodb-local.sh
./scripts/setup-dynamodb-local.sh

# 7. ブラウザでアクセス
# アプリケーション: http://localhost:8080
# phpMyAdmin: http://localhost:8081
```

### 6. 開発ワークフロー

```bash
# 環境起動
docker-compose up -d

# ログ確認
docker-compose logs -f

# 環境停止
docker-compose down

# 環境完全削除（データも削除）
docker-compose down -v

# MySQL接続
docker exec -it iizuna-lms-db mysql -u iizunaLMS -pGawbvgt2f983mru iizunaLMS

# アプリケーションコンテナ内でコマンド実行
docker exec -it iizuna-lms-app php app/Commands/summary_and_correct_answer_rate.php
```

### 7. トラブルシューティング

#### ポートが使用中
```bash
# 使用中のポート確認
lsof -i :8080
lsof -i :3306

# docker-compose.ymlのポートを変更
ports:
  - "8090:80"  # 8080 → 8090 に変更
```

#### MySQLに接続できない
```bash
# コンテナ起動確認
docker-compose ps

# MySQL起動待機
docker-compose logs mysql-iizuna

# 手動でデータベース作成
docker exec -it iizuna-lms-db mysql -u root -prootpassword
```

#### Composer依存関係エラー
```bash
# コンテナ内で再インストール
docker exec -it iizuna-lms-app composer install --no-cache
docker exec -it iizuna-lms-app composer dump-autoload
```

### メリット
✅ 完全にローカルで開発可能  
✅ インターネット接続不要（初回セットアップ後）  
✅ 本番環境を汚さない  
✅ チーム全員が同じ環境を構築できる  
✅ DynamoDB Localで本番と同等の機能をテスト  

### デメリット
❌ 初回セットアップに時間がかかる  
❌ Dockerの知識が必要  
❌ マシンスペックが必要（推奨: メモリ8GB以上）  
❌ Firebase/外部APIは実際のサービスに接続が必要

---

## xserver/Cloudflare/Vercelについて

### xserver（スタンダード・PHP 8.2.28）

#### 動作可能な機能
✅ PHP 8.2アプリケーション  
✅ MySQL（2つのデータベース作成可能）  
✅ Composer（SSH経由で実行可能）  
✅ 外部API連携  

#### 動作不可能な機能
❌ **AWS DynamoDB**（RDSやローカルDBでの代替が必要）  
❌ **Cron（毎分実行）**（最短5分間隔）  
❌ **Firebaseプッシュ通知**（ファイアウォール制約の可能性）  
❌ **Node.js/npm**（標準では利用不可）  

#### 結論
**部分的な機能テストのみ可能。完全な開発環境としては不適切。**

### Cloudflare

#### Pages
- 静的サイトホスティングのみ
- **PHPは動作不可**

#### Workers
- サーバーレスJavaScript環境
- **PHPは動作不可**（PHP.wasmで実行可能だが実用的でない）

#### 結論
**このプロジェクトには不適切。**

### Vercel

- Next.js/Node.jsに最適化
- **PHPは公式非対応**
- サーバーレス環境でMySQLの永続接続が困難

#### 結論
**このプロジェクトには不適切。**

---

## 推奨フロー

### 最速で開発開始する場合

1. **既存AWS開発環境にアクセス可能か確認**
   - SSHキー `spapp-dev-keypair.pem` があるか？
   - `ssh ec2-user@15.152.199.165` で接続できるか？

2. **アクセス可能** → プランA（AWS開発環境）
   - すぐに開発開始可能
   - 本番と同じ環境で安心

3. **アクセス不可** → プランB（ローカルDocker）
   - 初回セットアップに1-2時間
   - その後は完全にローカルで開発可能

---

## 次のステップ

### 確認事項
1. `spapp-dev-keypair.pem` の有無
2. AWS開発環境へのアクセス権限
3. ローカルマシンのスペック（メモリ8GB以上推奨）

### 準備が整ったら
- プランAの場合: SSH接続設定
- プランBの場合: Dockerファイル作成とセットアップ

ご希望のプランと、上記確認事項の結果をお知らせください。


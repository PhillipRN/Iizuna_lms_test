# 🎉 開発環境セットアップファイル作成完了

## 📋 作成されたファイル一覧

### Docker関連ファイル
- ✅ `docker-compose.yml` - Docker環境定義
- ✅ `Dockerfile` - PHPアプリケーションコンテナ
- ✅ `docker/apache-config.conf` - Apache設定
- ✅ `.dockerignore` - Dockerビルド時の除外ファイル

### 設定ファイル
- ✅ `app/config.docker.ini` - Docker環境用設定（ローカル開発用）
- ✅ `.gitignore` - Docker関連ファイルを追加

### スクリプトファイル
- ✅ `scripts/setup-dynamodb-local.sh` - DynamoDB Local初期化スクリプト
- ✅ `setup_database/init-db.sh` - MySQL初期化スクリプト
- ✅ `Makefile` - 開発コマンド集

### ドキュメント
- ✅ `docs/開発環境構築ガイド.md` - 完全版セットアップガイド
- ✅ `QUICKSTART.md` - クイックスタートガイド

### コード修正
- ✅ `app/Helpers/DynamoDBHelper.php` - DynamoDB Local対応

---

## 🚀 今すぐ開発環境を起動する

### 方法1: Makeコマンドを使用（推奨）

```bash
# 初回セットアップ（自動で全て実行）
make setup

# 起動後のアクセス
# - アプリケーション: http://localhost:8080
# - phpMyAdmin:       http://localhost:8081
# - MailHog:          http://localhost:8025
```

### 方法2: 手動で実行

```bash
# 1. 設定ファイルをコピー
cp app/config.docker.ini app/config.ini
cp app/token.ini.example app/token.ini
chmod 666 app/token.ini

# 2. Docker起動
docker-compose up -d

# 3. DynamoDBテーブル作成
./scripts/setup-dynamodb-local.sh

# 4. ブラウザでアクセス
open http://localhost:8080
```

---

## 🎯 開発環境の特徴

### 完全なローカル環境
✅ インターネット接続不要（初回セットアップ後）  
✅ 本番環境を汚さない  
✅ 自由に実験・破壊・再構築可能  

### 本番環境と同等の機能
✅ PHP 8.2  
✅ MySQL 8.0（iizunaLMS + onigiri）  
✅ DynamoDB Local  
✅ MailHog（メール送信テスト）  
✅ phpMyAdmin（DB管理）  

### 開発体験の最適化
✅ ファイル編集が即座に反映  
✅ ホットリロード対応  
✅ デバッグモード有効  
✅ 詳細なエラー表示  

---

## 📊 構築された環境の詳細

### Dockerコンテナ構成

| コンテナ名 | 役割 | ポート |
|-----------|------|--------|
| `iizuna-lms-app` | PHPアプリケーション | 8080 |
| `iizuna-lms-db` | MySQL（iizunaLMS） | 3306 |
| `iizuna-onigiri-db` | MySQL（onigiri） | 3307 |
| `iizuna-dynamodb` | DynamoDB Local | 8000 |
| `iizuna-phpmyadmin` | phpMyAdmin | 8081 |
| `iizuna-mailhog` | メールサーバー | 1025, 8025 |

### データベース構成

#### iizunaLMS DB
- ホスト: `mysql-iizuna`（Docker内）/ `localhost:3306`（ホストから）
- データベース: `iizunaLMS`
- ユーザー: `iizunaLMS`
- パスワード: `Gawbvgt2f983mru`

#### onigiri DB
- ホスト: `mysql-onigiri`（Docker内）/ `localhost:3307`（ホストから）
- データベース: `onigiri`
- ユーザー: `onigiri`
- パスワード: `onigiri_pass`

#### DynamoDB Local
- エンドポイント: `http://dynamodb-local:8000`（Docker内）/ `http://localhost:8000`（ホストから）
- テーブル:
  - `dev-access-token`
  - `dev-login-token`
  - `dev-auto-login-token`

---

## 🛠️ よく使うコマンド

```bash
# 環境管理
make up           # 起動
make down         # 停止
make restart      # 再起動
make logs         # ログ表示
make ps           # 状態確認
make status       # 詳細な状態確認

# 開発作業
make shell        # コンテナに入る
make mysql        # MySQLに接続
make test         # テスト実行

# メンテナンス
make composer-install   # 依存関係インストール
make dynamodb-setup     # DynamoDBテーブル作成
make rebuild            # イメージ再ビルド
make clean              # 完全削除
```

---

## 📖 次に読むべきドキュメント

1. **[QUICKSTART.md](../QUICKSTART.md)**  
   → 最速で環境を起動したい

2. **[docs/開発環境構築ガイド.md](開発環境構築ガイド.md)**  
   → 詳細な設定や説明を知りたい

3. **[ReadMe.md](../ReadMe.md)**  
   → 本番環境のデプロイ方法を知りたい

4. **[API.md](../API.md)**  
   → API仕様を確認したい

---

## ⚠️ 重要な注意事項

### 設定ファイルについて

#### `app/config.ini`（gitignore済み）
このファイルは**Gitにコミットされません**。  
各開発者が以下のいずれかをコピーして使用します：

- `app/config.docker.ini` - Docker環境用
- `app/config.ini.example` - テンプレート

#### DynamoDB Endpoint設定

`app/config.ini` に以下の設定があることを確認：

```ini
DYNAMO_DB_ENDPOINT = http://dynamodb-local:8000
```

この設定がある場合、`DynamoDBHelper.php`が自動的にローカル環境を使用します。  
本番環境では、この設定を**削除または空文字**にすることで、AWS本番環境に接続します。

### Firebase認証ファイル

現在、`firebase_auth.json`は設置されていません。  
Firebase Cloud Messaging（プッシュ通知）を使用する場合は、別途設置が必要です：

```bash
# Firebaseコンソールから認証ファイルをダウンロード
# app/firebase_auth.json として配置
```

### 外部API接続

`app/config.docker.ini`では、外部APIのURLがプレースホルダーになっています：

```ini
ONIGIRI_API = https://onigiri-dev-api.example.net/
DENSHI_SHOSEKI_API = https://dev-api.example.com
```

実際の開発環境APIのURLに書き換えてください。

---

## 🐛 トラブルシューティング

### ポート競合エラー

```bash
Error: Port 8080 is already in use
```

**解決策**: `docker-compose.yml` のポート番号を変更

```yaml
ports:
  - "8090:80"  # 8080 → 8090
```

### データベース接続エラー

```bash
SQLSTATE[HY000] [2002] Connection refused
```

**解決策**: データベースの起動を待つ

```bash
# 起動状態を確認
docker-compose ps

# ログを確認
docker-compose logs mysql-iizuna

# 再起動
docker-compose restart mysql-iizuna
```

### DynamoDBテーブルが作成されない

```bash
# AWS CLIがインストールされているか確認
aws --version

# macOSの場合
brew install awscli

# 再実行
./scripts/setup-dynamodb-local.sh
```

### Composer依存関係エラー

```bash
# コンテナ内で再インストール
docker exec -it iizuna-lms-app bash
composer install --no-cache
composer dump-autoload
exit
```

---

## 💡 開発のヒント

### コード変更の即座反映

PHPファイルを編集すると、Docker内に即座に反映されます：

1. エディタでファイルを編集
2. 保存
3. ブラウザをリロード
4. 変更が反映される

### デバッグ出力

```php
// エラーログに出力
error_log("Debug: " . print_r($data, true));

// 画面に出力（デバッグモードのみ）
var_dump($data);
die();
```

### データベースGUI

phpMyAdmin（http://localhost:8081）で視覚的にデータベース操作が可能：

- テーブル構造の確認
- データの追加・編集・削除
- SQLクエリの実行
- データのエクスポート・インポート

### メール送信テスト

MailHog（http://localhost:8025）で送信メールを確認：

- SMTPサーバー不要
- 送信されたメールをブラウザで確認
- 実際のメール送信は行われない（テスト環境に最適）

---

## 🎓 既存AWS開発環境との比較

| 項目 | AWS開発環境 | ローカルDocker環境 |
|------|------------|-------------------|
| **初期セットアップ** | SSHキーが必要 | Docker Desktopのみ |
| **起動速度** | SSH接続 | 即座に起動 |
| **ネットワーク** | 必須 | 不要（初回後） |
| **外部サービス** | 本番のものを使用 | ローカルエミュレート |
| **データベース** | 共有 | 独立 |
| **自由度** | 制限あり | 完全に自由 |
| **本番環境との一致** | 100% | 95% |

### どちらを使うべき？

**AWS開発環境を使う場合：**
- 本番環境と完全に同じ動作を確認したい
- Firebase等の外部サービスをそのまま使いたい
- チーム全体で共有のデータベースを使いたい

**ローカルDocker環境を使う場合：**
- オフラインで開発したい
- 自由に実験・破壊・再構築したい
- 自分専用の開発環境が欲しい
- 初めて開発に参加する

**推奨**: まずローカルDocker環境で開発に慣れ、本番デプロイ前にAWS開発環境で最終確認。

---

## ✅ チェックリスト

開発環境が正しく起動しているか確認：

- [ ] `docker-compose ps` で全コンテナが `Up` 状態
- [ ] http://localhost:8080 にアクセスできる
- [ ] http://localhost:8081 でphpMyAdminが開く
- [ ] `make mysql` でMySQLに接続できる
- [ ] `./scripts/setup-dynamodb-local.sh` でテーブル作成成功
- [ ] `make test` でPHPUnitが実行される

すべて✅になれば、開発環境の構築完了です！

---

## 📞 サポート

問題が発生した場合：

1. **ログを確認**  
   ```bash
   make logs
   ```

2. **状態を確認**  
   ```bash
   make status
   ```

3. **完全リセット**  
   ```bash
   make clean
   make setup
   ```

4. **ドキュメントを参照**  
   - [開発環境構築ガイド](開発環境構築ガイド.md)
   - [QUICKSTART.md](../QUICKSTART.md)

---

**Happy Coding! 🚀**


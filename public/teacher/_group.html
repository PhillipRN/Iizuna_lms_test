<!DOCTYPE html>
<html lang="ja">
<head>
    {include file='_gtag.html'}
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <title>Class/Group</title>

    {include file='_favicon.html'}

    <link rel="stylesheet" href="../common/styles/reset.css" type="text/css">
    <link rel="stylesheet" href="./common/styles/layout.css?20240120" type="text/css">
    <script src="../common/scripts/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        $(function() {
            $('#groupRegistrationForm').submit(registrationSubmit);
            $('.operation').click(moveUpdatePage);
            $('.qrCode').click(jumpQrPage);
            $('#qrForm').submit(submitQrForm);
        });

        function registrationSubmit() {
            let form = $('#groupRegistrationForm');

            var errors = [];

            if ($('#group_name').val() == '') {
                errors.push('発行するコードの名前を入力してください。');
            }

            if (errors.length != 0) {
                $('#errors').html(errors.join('<br>'));
                $(window).scrollTop($('#errors').position().top);
            }
            else {
                $('#errors').html('');

                $.ajax({
                    url: 'group_register.php',
                    type: 'post',
                    data: form.serialize(),
                    timeout: 30000,
                })
                    .done(function(result) {
                        if (result.error != null)
                        {
                            $('#errors').html(result.error['message'] + ' (' + result.error['code'] + ')');
                            return;
                        }
                        else
                        {
                            alert('登録しました。');
                            window.location = './group.php';
                            return;
                        }
                    })
                    .fail(function(result) {
                        alert('エラーが発生しました。');
                        return;
                    });
            }

            return false;
        }

        function jumpQrPage() {
            let id = $(this).data('id');
            let type = $(this).data('type');

            let options = 'width=1024px,height=800px,menubar=no';

            if (type == 'school') {
                window.open('./qr.php?school_id=' + id, 'QRCodeWindow', options);
            }
            else {
                window.open('./qr.php?group_ids[]=' + id, 'QRCodeWindow', options);
            }

            return false;
        }

        function submitQrForm() {
            let form = $('#qrForm');
            let query = form.serialize();

            if (query != "") {
                let options = 'width=1024px,height=800px,menubar=no';
                window.open('./qr.php?' + query, 'QRCodeWindow', options);
            }

            return false;
        }

        function moveUpdatePage() {
            let lcid = $(this).data('lcid');

            location.href = './group_update.php?lcid=' + lcid;
            return false;
        }
    </script>
</head>
<body>
<div id="container">
    <div id="menuArea">
        <div id="logoArea">
            <img src="common/images/logo.png" alt="Test Creator LMS" />
        </div>
{include file='_side_menu.html' isJuku=$isJuku current='group'}
    </div>

    <div id="contentArea">
        <div id="addCode">
            <h2>グループコード発行</h2>
            <p>発行するコードの名前を入力してください。</p>
            <div id="errors" class="caution"></div>
            <form method="post" id="groupRegistrationForm">
                <input type="text" name="name" class="borderBox" id="group_name" />
                <div class="buttonArea">
                    <input type="submit" value="登録" class="normalButton" />
                </div>
            </form>
        </div>

        <div id="codeList">
            <h2>所属学校発行コード</h2>
            <form action="./qr.php" method="get" id="qrForm">
                <table class="separateTable">
                    <tr>
                        <th class="checkboxCell"></th>
                        <th>コード名</th>
                        <th>発行者</th>
                        <th>有料/無料</th>
                        <th>人数</th>
                        <th style="width: 300px">コード</th>
                        <th style="width: 80px">操作</th>
                    </tr>
                    {foreach $records as $record name='loop'}
                    <tr>
                        <td class="checkboxCell"><input type="checkbox" name="{if $record.is_school}school_id{else}group_ids[]{/if}" value="{$record.id}" /></td>
                        <td>{$record.name}</td>
                        <td>{if empty($record.teacher_name_1) && empty($record.teacher_name_2)}-{else}{$record.teacher_name_1} {$record.teacher_name_2}{/if}</td>
                        <td>
                            {if $record.paid_application_status == 1}
                                申請中
                            {else}
                                {if $record.is_paid == 1}有料{else}無料{/if}
                            {/if}
                        </td>
                        <td>
                            {if $record.is_school == 0 && $record.is_paid == 1}
                            {if $record.paid_application_status == 1}
                            -
                            {else}
                            {$record.application_total}
                            {/if}
                            {else}-{/if}
                        </td>
                        <td>
                            {if $record.paid_application_status == 1}-{else}{$record.lms_code}{/if}
                            <div class="rightButtonArea">
                                <button class="normalButton middle {if $record.paid_application_status == 1}disabled{else}qrCode{/if}" data-id="{$record.id}" data-type="{if $record.is_school}school{else}group{/if}">QRコード生成</button>
                            </div>
                        </td>
                        <td>{if $record.is_school}-{else}<div class="centerButtonArea"><button class="normalButton x-small isEnable operation" data-lcid="{$record.lms_code_id}" onclick="">操作</button></div>{/if}</td>
                        </td>
                    </tr>
                    {/foreach}
                </table>
                <div id="deliverySelected">
                    <input type="submit" value="まとめてQRコード生成" class="normalButton" />
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
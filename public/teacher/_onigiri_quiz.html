<!DOCTYPE html>
<html lang="ja">
<head>
    {include file='_gtag.html'}
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <title>おにぎり英単語用テスト作成</title>

    {include file='_favicon.html'}

    <link rel="stylesheet" href="../common/styles/reset.css" type="text/css">
    <link rel="stylesheet" href="./common/styles/layout.css?20240120" type="text/css">
    <link rel="stylesheet" href="./common/styles/onigiri_quiz.css" type="text/css">
    <link rel="stylesheet" href="./common/styles/scroll_box.css" type="text/css">
    <link rel="stylesheet" href="../common/tablesorter/css/theme.default.min.css" type="text/css">
    <link rel="stylesheet" href="./common/styles/folder.css" type="text/css">
    <link rel="stylesheet" href="./common/styles/modal.css" type="text/css">
    <script src="./common/scripts/onigiri_preview.js"></script>
    <script src="../common/scripts/jquery-3.6.0.min.js"></script>
    <script src="../common/tablesorter/js/jquery.tablesorter.min.js"></script>

    <!-- flatpickr -->
    <link rel="stylesheet" type="text/css" href="../common/flatpickr/flatpickr.min.css" />
    <script src="../common/flatpickr/flatpickr.min.js"></script>
    <script src="../common/flatpickr/l10n/ja.js"></script>

    <script type="text/javascript">
        $(function() {
            $(".period").flatpickr({
                'locale' : 'ja',
                'dateFormat' : 'Y-m-d H:i',
                enableTime  : true
            });

            var close = $('.modal-close'),
                container = $('.modal-container');
            $('.folderNode').on('click',changeFolder);

            $('#folderName').on('click', function(){
                $('.modal-container').addClass('active');
                return false;
            });

            close.on('click', function(){
                container.removeClass('active');
            });

            $(document).on('click', function(e) {
                if(!$(e.target).closest('.modal-body').length) {
                    container.removeClass('active');
                }
            });

            $('.childrenFolder a').on('click', moveChildFolder);
            $('.parentFolder a').on('click', moveChildFolder);
            $('#resetButton').on('click', resetSearch);
            $('#omakaseButton').on('click', moveCreateForOmakase);
            $('#manualButton').on('click', moveCreateForManual);

            $('#resultClass').change(changeClass);
            $('#resultTable').tablesorter({
                headers: {
{if $resultRecords}
{foreach $resultRecords.quizzes as $quiz}
                    {$quiz@index + 2}: { sorter:false }{if !$quiz@last},{/if}

{/foreach}
{/if}
                },
                emptyTo: 'emptyMax',
                sortReset: true
            });
        });
    </script>
    <script type="text/javascript">
        function changeClass() {
            window.location.href = './onigiri_quiz.php?lcid=' + $(this).val();
        }

        function deleteQuiz(testName, quizId, caution) {
            var message = "「" + testName + "」を削除します。\nよろしいですか？";

            if (caution) {
                message = "※このテストはすでに回答者がいます※\n削除した場合はテストの結果も削除されますのでご注意ください。\n\n"+ message
            }

            if (confirm(message)) {
                $.ajax({
                    url: 'onigiri_quiz_delete.php',
                    type: 'post',
                    data: { 'quiz_id': quizId, '_csrf': '{$csrf}' },
                    async : false,
                    timeout: 30000,
                })
                .done(function(result) {
                    if (result.error != null)
                    {
                        alert(result.error.message);
                    }
                    else if(result.result == 'OK')
                    {
                        alert('削除しました');
                        location.reload();
                    }
                    else
                    {
                        alert('予期せぬエラーが発生しました');
                    }
                })
                .fail(function(result) {
                    alert('予期せぬエラーが発生しました');
                });
            }
        }

        var currentPage = {$currentPage};

        function pageNext() {
            movePage(1);
        }

        function pagePrev() {
            movePage(-1);
        }

        function movePage(addValue) {
            var nextPage = currentPage + addValue;
            if (nextPage <= 0) nextPage = 1;

            $('#page').val(nextPage);
            $('#searchForm').submit();
        }

        function changeFolder() {
            let id = $(this).data('id');
            let folderName = $(this).html();

            $('#folderName').html(folderName);
            $('#parentFolderId').val(id);
            $('.modal-container').removeClass('active');
        }

        function moveChildFolder() {
            let id = $(this).data('id');

            $('#parentFolderId').val(id);
            $('#page').val('');
            $('#title').val('');
            $('#teacher').val('');
            $('#startDate').val('');
            $('#endDate').val('');
            $('#is_manual_mode_none').prop('checked', true);
            $('#searchForm').submit();
        }

        function resetSearch() {
            $('#parentFolderId').val(0);
            $('#page').val('');
            $('#title').val('');
            $('#teacher').val('');
            $('#startDate').val('');
            $('#endDate').val('');
            $('#is_manual_mode_none').prop('checked', true);
            $('#searchForm').submit();
        }

        function moveCreateForOmakase()
        {
            let parentFolderId = $('#parentFolderId').val();
            location.href='./onigiri_quiz_create.php?parent_folder_id=' + parentFolderId;
        }

        function moveCreateForManual()
        {
            let parentFolderId = $('#parentFolderId').val();
            location.href='./onigiri_quiz_create.php?manual=1&parent_folder_id=' + parentFolderId;
        }
    </script>
</head>
<body>
<div id="container">
    <div id="menuArea">
        <div id="logoArea">
            <img src="common/images/logo.png" alt="Test Creator LMS" />
        </div>
{include file='_side_menu.html' isJuku=$isJuku current='onigiri_quiz'}
    </div>
    <div id="contentArea">
        <h2>e-ONIGIRI英単語 テスト結果</h2>

        <select id="resultClass">
            {foreach $schoolGroups as $schoolGroup name='loop'}
            <option value="{$schoolGroup.lms_code_id}" {if $currentLmsCodeId==$schoolGroup.lms_code_id}selected{/if}>{$schoolGroup.name}</option>
            {/foreach}
        </select>

        <div>
            <a href="onigiri_quiz_result_download_csv.php?lcid={$currentLmsCodeId}" download="result_{$currentGroupName}.csv" class="download-btn">CSVダウンロード</a>
        </div>

        <div class="scroll-box">
            {if $resultRecords}
            <table id="resultTable">
                <thead>
                <tr class="tablesorter-ignoreRow">
                    <th class="name _sticky"></th>
                    <th class="student_number _sticky"></th>
                    {foreach $resultRecords.quizzes as $quiz}
                    {if $quiz.open_date == '1000-01-01 00:00:00'}
                    {assign var=open_date value=""}
                    {else}
                    {assign var=open_date value="`$quiz.open_date`"}
                    {/if}
                    <td>{$open_date|date_format:"%-m月%-d日"}</td>
                    {/foreach}
                </tr>
                <tr>
                    <th class="name _sticky">生徒名</th>
                    <th class="_sticky">学籍番号</th>
                    {foreach $resultRecords.quizzes as $quiz}
                    <td>{$quiz.title}</td>
                    {/foreach}
                </tr>
                </thead>
                <tbody>
                {foreach $resultRecords.studentResults as $studentResults name='loop'}
                <tr>
                    <th class="name _sticky">{$studentResults.name}</th>
                    <th class="_sticky">{$studentResults.student_number}</th>
                    {foreach $resultRecords.quizzes as $quiz}
                    {assign var=result value=$studentResults.results[$quiz.onigiri_json_quiz_id]}
                    <td>{if $result===null}<span class="caution">未</span>{else}{$result}/{$quiz.total}点{/if}</td>
                    {/foreach}
                </tr>
                {/foreach}
                </tbody>
            </table>
            <div id="resultPageControl">
                <button id="prev" class="normalButton x-small {if $currentResultPage == 1}disabled{/if}" {if $currentResultPage > 1}onclick='location.href="onigiri_quiz.php?lcid={$currentLmsCodeId}&resultPage={$currentResultPage - 1}"'{/if}>前へ</button>
                <button id="next" class="normalButton x-small {if $currentResultPage >= $maxResultPageNumber}disabled{/if}" {if $currentResultPage < $maxResultPageNumber}onclick='location.href="onigiri_quiz.php?lcid={$currentLmsCodeId}&resultPage={$currentResultPage + 1}"'{/if}>次へ</button>
            </div>
            {else}
            データがありません。
            {/if}
        </div>

        <h2 style="margin-top: 50px">e-ONIGIRI英単語 テスト作成</h2>

        <div class="onigiriQuizCreateButtonArea">
            <button class="normalButton large" id="omakaseButton">おまかせモード</button>
            <button class="normalButton large" id="manualButton">マニュアルモード</button>
        </div>

        <form action="" method="get" id="searchForm" style="margin-bottom: 30px">
            <input type="hidden" name="page" id="page" />
            <table>
                <tbody>
                <tr>
                    <td>テスト名</td>
                    <td><input type="text" name="title" value="{$searchParams->title}" id="title" /></td>
                    <td style="padding-left: 15px">モード</td>
                    <td>
                        <input type="radio" name="is_manual_mode" value="" id="is_manual_mode_none" {if $searchParams->is_manual_mode==null && $searchParams->is_manual_mode!=="0"}checked{/if} /><label for="is_manual_mode_none"> なし</label>　
                        <input type="radio" name="is_manual_mode" value="0" id="is_manual_mode_0" {if $searchParams->is_manual_mode==="0"}checked{/if} /><label for="is_manual_mode_0"> おまかせモード</label>　
                        <input type="radio" name="is_manual_mode" value="1" id="is_manual_mode_1" {if $searchParams->is_manual_mode==1}checked{/if} /><label for="is_manual_mode_1"> マニュアルモード</label>
                    </td>
                </tr>
                <tr>
                    <td>作成者</td>
                    <td>
                        <select name="teacher_id" id="teacher" style="width: 200px">
                            <option value=""></option>
                            {foreach $teachers as $teacher name='loop'}
                            {$teacher|var_dump}
                            <option value="{$teacher.id}" {if $searchParams->teacher_id==$teacher.id}selected{/if}>{$teacher.name_1} {$teacher.name_2}</option>
                            {/foreach}
                        </select>
                    </td>
                    <td style="padding-left: 15px">作成日</td>
                    <td>
                        <input type="text" name="start_date" value="{$searchParams->start_date}" style="width: 130px;" class="period" id="startDate" /> ～
                        <input type="text" name="end_date" value="{$searchParams->end_date}" style="width: 130px;" class="period" id="endDate" />
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="currentFolder">
                <a href="javascript:void(0)" id="folderName">{$currentFolder.name}</a>
                <input type="hidden" name="parent_folder_id" value="{$currentFolder.id}" id="parentFolderId" />
            </div>
            <input type="submit" value="検索" class="normalButton middle" />
            <button class="normalButton middle disabled" id="resetButton">リセット</button>
        </form>

        <table class="separateTable">
            <thead>
            <tr>
                <th>
                    テスト名
                    <hr />
                    期間
                </th>
                <th style="width: 150px">
                    作成者
                    <hr />
                    作成日時
                </th>
                <th style="width: 280px"></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td colspan="5">
                    <div class="parentFolder">
                        {if $currentFolder.id != 0}
                        <a href="javascript:void(0)" data-id="{$currentFolder.parent_folder_id}">上のフォルダへ</a>
                        {else}
                        上のフォルダへ
                        {/if}
                    </div>
                </td>
            </tr>
            {foreach $childrenFolders as $childrenFolder name='loop'}
            <tr>
                <td colspan="5">
                    <div class="childrenFolder">
                        <a href="javascript:void(0)" data-id="{$childrenFolder.id}">{$childrenFolder.name}</a>
                    </div>
                </td>
            </tr>
            {/foreach}

{if !empty($records)}
            {foreach $records as $record name='loop'}
            {assign var=isMyRecord value=0}
            {if $record.teacher_id == $teacherId}{assign var=isMyRecord value=1}{/if}
            <tr>
                <td>
                    {$record.title}
                    <hr />
                    {if empty($record.open_date) && empty($record.expire_date)} -
                    {else} {if !empty($record.open_date)}{$record.open_date|date_format:"%g-%m-%d %H:%M"}{/if} ～ {$record.expire_date|date_format:"%g-%m-%d %H:%M"}  {/if}
                </td>
                <td>
                    {$record.teacher_name_1} {$record.teacher_name_2}
                    <hr />
                    {$record.create_date|date_format:"%g-%m-%d %T"}
                </td>
                <td>
                    <div>
                        {assign var=manual_flag value=""}
                        {if ($record.is_manual_mode) == 1}{assign var=manual_flag value="&manual=1"}{/if}
{if $isMyRecord}
                        <button class="normalButton x-small {if !$record.is_delivery}blue{/if}" onclick="window.location.href='./onigiri_quiz_delivery.php?quiz_id={$record.id}'">配信</button>
                        <button class="normalButton small" onclick="window.location.href='./onigiri_quiz_result_list.php?quiz_id={$record.id}'">結果一覧</button>
                        <button class="normalButton x-small" onclick="window.location.href='./onigiri_quiz_statistics.php?quiz_id={$record.id}'">統計</button>
                        <button class="normalButton small" onclick="openPreview('{$record.id}')">プレビュー</button>
                        <br />
                        <button class="normalButton middle" onclick="window.location.href='./onigiri_quiz_create.php?quiz_id={$record.id}{$manual_flag}'">範囲修正・再生成</button>
                        <button class="normalButton x-small delete" onclick="deleteQuiz('{$record.title}', {$record.id}, {if $record.result_num == 0}false{else}true{/if})">削除</button>
{else}
                        <button class="normalButton small" onclick="openPreview('{$record.id}')">プレビュー</button>
                        <br />
                        <button class="normalButton middle" onclick="window.location.href='./onigiri_quiz_create.php?quiz_id={$record.id}{$manual_flag}'">範囲確認</button>
{/if}
                    </div>
                </td>
            </tr>
            {/foreach}
{/if}
            </tbody>
        </table>

{if empty($records)}
        データがありません。
{else}
        <div id="historyPageControl">
            <button class="prev normalButton x-small {if $currentPage == 1}disabled{/if}" {if $currentPage > 1}onclick="pagePrev()"{/if}>前へ</button>
            <button class="next normalButton x-small {if $currentPage >= $maxPageNumber}disabled{/if}" {if $currentPage < $maxPageNumber}onclick="pageNext()"{/if}>次へ</button>
        </div>
{/if}
    </div>
</div>

<div class="modal-container">
    <div class="modal-body">
        <div class="modal-close">×</div>
        <div class="modal-content">
            <div id="choiceFolderContent">
                <div id="folderManagementButton">
                    <button class="normalButton middle" onclick="window.location.href='./onigiri_quiz_folder.php'">フォルダ管理</button>
                </div>
                <ul class="folderTree">
                    <li>
                        <a href="javascript:void(0)" data-id="all" data-parent_folder_id="0" data-teacher_id="0" class="folderNode">全てのフォルダ</a>
                    </li>
                </ul>
                {$folderListHtml}
            </div>
        </div>
    </div>
</div>
</body>
</html>
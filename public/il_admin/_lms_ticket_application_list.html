<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <title>管理画面</title>

    {include file='_favicon.html'}

    <link rel="stylesheet" href="../common/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./common/style.css?20240421" type="text/css">
    <link rel="stylesheet" href="./common/admin.css?202303261524" type="text/css">
    <script src="common/scripts/admin.js"></script>
    <script src="../common/scripts/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        function apploveBook(name, id) {
            $('#errors').html('');

            if (!confirm(name + "\nを承認しますか？")) return;

            $.ajax({
                url: 'lms_ticket_application_register.php',
                type: 'post',
                data: { 'id': id },
                timeout: 30000,
            })
                .done(function(result) {
                    if (result.error != null)
                    {
                        $('#errors').html(result.error['message'] + ' (' + result.error['code'] + ')');
                        return;
                    }
                    else if (result.result == 'OK')
                    {
                        alert('承認しました。');
                        location.reload();
                        return;
                    }
                    else
                    {
                        alert('予期せぬエラーが発生しました。');
                        return;
                    }
                })
                .fail(function(result) {
                    alert('エラーが発生しました。');
                    return;
                });
        }

        function canselApplication(name, id) {
            if (!confirm(name + "\nの申請を取り消します。\nよろしいですか？")) return false;

            $('#errors').html('');

            $.ajax({
                url: 'lms_ticket_application_canceler.php',
                type: 'post',
                data: { ltaid: id },
                timeout: 30000,
            })
            .done(function(result) {
                if (result.error != null)
                {
                    $('#errors').html(result.error['message'] + ' (' + result.error['code'] + ')');
                    return;
                }
                else
                {
                    alert('取り消しました。');
                    location.reload();
                    return;
                }
            })
            .fail(function(result) {
                alert('エラーが発生しました。');
                return;
            });

            return false;
        }
    </script>
</head>
<body>
<p style="margin: 10px;"><a href="index.php">戻る</a></p>
<hr />
<div id="contents">
    <div class="container-fluid">
        <div class="row">
            <div class="col-8"><h1>LMSチケット購入申請管理</h1></div>
        </div>
    </div>

    <br />
    <a href="lms_ticket_application_list_csv.php" download="lms_ticket_application_list_csv.csv" class="download-btn">CSVダウンロード</a>

    <div style="margin-top:25px; text-align: right; margin-bottom: 15px;">
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="location.href='lms_ticket_grant.php?back_application_list_page={$currentPage}'">チケット付与</button>
    </div>

    <div id="errors" class="text-danger error"></div>
    <table class="table table-striped table-hover table-bordered">
        <thead>
        <tr>
            <th scope="col">申請日時</th>
            <th scope="col">学校/氏名</th>
            <th scope="col">種別</th>
            <th scope="col">有効期限</th>
            <th scope="col">購入申請人数</th>
            <th scope="col">ステータス</th>
            <th scope="col">操作</th>
        </tr>
        </thead>
        <tbody>
{foreach $records as $record name='loop'}
{if isset($ticketTypes[$record.title_no])}
    {assign var=bookName value=$ticketTypes[$record.title_no]['name']}
{else}
    {assign var=bookName value=""}
{/if}
        <tr>
            <th scope="row">{$record.create_date|date_format:"%Y-%m-%d %T"}</th>
            <td>{$record.school_name}
{if !empty($record.teacher_name_1)}
                <br />
                {$record.teacher_name_1} {$record.teacher_name_2}
{/if}
            </td>
            <td>{$bookName}</td>
            <td>{$record.expire_year}年{$record.expire_month}月</td>
            <td>{$record.quantity}</td>
            <td style="text-align: center"{if $record.lms_ticket_application_status==2} class="bg-success text-white"{/if}>
{if $record.lms_ticket_application_type == 2}
    {if $record.teacher_id == 0}
            管理者が学校に付与
    {else}
            管理者が先生に付与
    {/if}
{else}
    {if $record.lms_ticket_application_status == 1}
                申請中
    {else if $record.lms_ticket_application_status == 2}
                承認済
    {/if}
{/if}
            </td>
            <td>
                {if $record.lms_ticket_application_status==1}
                <div style="margin-bottom: 10px">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="apploveBook('{$bookName}', '{$record.id}')">承認</button>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="canselApplication('{$bookName}', '{$record.id}')">取り消し</button>
                {/if}
            </td>
        </tr>
{/foreach}
        </tbody>
    </table>
    <nav aria-label="...">
        <ul class="pagination pagination-sm">
{if $currentPage < 6}
{assign var=startPage value=1}
{assign var=endPage value=10}
{else}
{assign var=startPage value=$currentPage-5}
{assign var=endPage value=$currentPage+4}
{/if}
{if $endPage > $maxPageNum}
{assign var=endPage value=$maxPageNum}
{/if}

            {for $page=$startPage to $endPage}
            {if $page==$currentPage}
            <li class="page-item disabled">
                <a class="page-link">{$page}</a>
            </li>
            {else}
            <li class="page-item"><a class="page-link" href="lms_ticket_application_list.php?page={$page}">{$page}</a></li>
            {/if}
            {/for}
        </ul>
    </nav>
</div>
</body>
</html>
